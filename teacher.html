<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€å¸«ç®¡ç†å¾Œå° - å­¸ç”Ÿå•ç­”ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .tab-active { border-bottom: 4px solid #1d4ed8; color: #1d4ed8; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <!-- å°è¦½åˆ— -->
    <nav class="bg-slate-800 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
            <span class="text-xl font-bold tracking-wider">ğŸ‘¨â€ğŸ« è€å¸«ç®¡ç†å¾Œå°</span>
            <div class="flex items-center gap-4">
                <span id="adminName" class="text-sm bg-slate-700 px-3 py-1 rounded">è¼‰å…¥ä¸­...</span>
                <button onclick="logout()" class="text-sm bg-red-600 hover:bg-red-700 px-3 py-1 rounded transition">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto p-4 md:p-6">
        
        <!-- åŠŸèƒ½åˆ†é åˆ‡æ› -->
        <div class="flex bg-white rounded-t-xl border-b mb-6 overflow-hidden shadow-sm">
            <button onclick="switchTab('questions')" id="tab-questions" class="flex-1 py-4 font-bold text-lg tab-active transition">é¡Œç›®ç®¡ç†</button>
            <button onclick="switchTab('students')" id="tab-students" class="flex-1 py-4 font-bold text-lg text-slate-500 transition">å­¸ç”Ÿæ¸…å–®</button>
            <button onclick="switchTab('settings')" id="tab-settings" class="flex-1 py-4 font-bold text-lg text-slate-500 transition">ç­ç´šè¨­å®š</button>
        </div>

        <!-- åˆ†é  1: é¡Œç›®ç®¡ç† -->
        <section id="section-questions" class="space-y-6">
            <!-- ç™¼å¸ƒæ–°é¡Œç›®æŒ‰éˆ• -->
            <div class="flex justify-end">
                <button onclick="openCreateModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center gap-2 text-lg transition transform active:scale-95">
                    <span>â• ç™¼å¸ƒæ–°é¡Œç›®</span>
                </button>
            </div>

            <!-- é¡Œç›®åˆ—è¡¨å®¹å™¨ -->
            <div id="questionList" class="grid gap-6">
                <!-- è¼‰å…¥ä¸­ç‹€æ…‹ -->
                <div class="text-center py-12 text-slate-400">æ­£åœ¨è®€å–æœ€æ–°é¡Œç›®...</div>
            </div>
        </section>

        <!-- åˆ†é  2: å­¸ç”Ÿæ¸…å–® (å¾…å¾ŒçºŒå¯¦ä½œè©³ç´°é‚è¼¯) -->
        <section id="section-students" class="hidden">
            <div class="bg-white rounded-xl shadow p-6">
                <h2 class="text-2xl font-bold mb-4">å­¸ç”Ÿå¸³è™Ÿç®¡ç†</h2>
                <div id="studentList" class="divide-y">
                    <p class="py-4 text-slate-500">æ­£åœ¨è¼‰å…¥å­¸ç”Ÿè³‡æ–™...</p>
                </div>
            </div>
        </section>

        <!-- åˆ†é  3: ç­ç´šè¨­å®š -->
        <section id="section-settings" class="hidden">
            <div class="bg-white rounded-xl shadow p-6 space-y-8">
                <div>
                    <h2 class="text-2xl font-bold mb-4">ç­ç´šè¨»å†Šé‚€è«‹ç¢¼</h2>
                    <div class="flex items-center gap-4">
                        <div id="inviteCodeDisplay" class="text-4xl font-mono font-bold bg-slate-100 px-6 py-2 rounded-lg border-2 border-dashed border-slate-300">ABCD</div>
                        <button onclick="refreshInviteCode()" class="bg-slate-800 text-white px-4 py-2 rounded hover:bg-slate-700 transition">é‡æ–°ç”¢ç”Ÿ</button>
                    </div>
                    <p class="text-slate-500 mt-2 text-sm">è«‹å°‡æ­¤ä»£ç¢¼äº¤çµ¦å­¸ç”Ÿé€²è¡Œè¨»å†Šã€‚</p>
                </div>
            </div>
        </section>

    </main>

    <!-- Modal: æ–°å¢é¡Œç›® -->
    <div id="createModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-[60]">
        <div class="bg-white rounded-2xl w-full max-w-lg overflow-hidden shadow-2xl">
            <div class="bg-slate-800 p-4 text-white font-bold text-lg">ç™¼å¸ƒæ–°é¡Œç›®</div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block font-bold text-slate-700 mb-1">é¡Œç›®åç¨±</label>
                    <textarea id="newTitle" rows="3" class="w-full border-2 border-slate-200 rounded-lg p-3 focus:border-blue-500 outline-none" placeholder="ä¾‹å¦‚ï¼šè«‹åˆ†äº«ä½ å°ä»Šå¤©èª²ç¨‹çš„å¿ƒå¾—"></textarea>
                </div>
                <div>
                    <label class="block font-bold text-slate-700 mb-1">æ”¶ä»¶æˆªæ­¢æ™‚é–“</label>
                    <div class="flex items-center gap-3">
                        <input type="number" id="deadlineHours" value="1" min="0" class="w-20 border-2 border-slate-200 rounded p-2 text-center"> å°æ™‚
                        <input type="number" id="deadlineMins" value="0" min="0" max="59" class="w-20 border-2 border-slate-200 rounded p-2 text-center"> åˆ†é˜
                    </div>
                    <p class="text-xs text-slate-400 mt-1">å¾ç¾åœ¨èµ·ç®—å¤šä¹…å¾Œåœæ­¢æ”¶ä»¶</p>
                </div>
                <div class="flex gap-3 pt-4">
                    <button onclick="closeCreateModal()" class="flex-1 py-3 font-bold text-slate-500 bg-slate-100 rounded-lg hover:bg-slate-200 transition">å–æ¶ˆ</button>
                    <button id="confirmCreateBtn" onclick="submitNewQuestion()" class="flex-1 py-3 font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700 shadow-md transition">ç¢ºèªç™¼å¸ƒ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–è¼‰å…¥
        window.onload = async () => {
            await checkAuth();
            await fetchQuestions();
        };

        // 1. èº«åˆ†æª¢æŸ¥ (æ ¸å¿ƒé‚è¼¯ï¼šè‹¥å›å‚³ 401 å‰‡è¸¢å›ç™»å…¥é )
        async function checkAuth() {
            try {
                const res = await fetch('/api/auth/me');
                if (!res.ok) throw new Error('æœªç™»å…¥');
                const user = await res.json();
                document.getElementById('adminName').innerText = `ğŸ‘¤ è€å¸«ï¼š${user.username}`;
            } catch (err) {
                window.location.href = 'teacher_login.html';
            }
        }

        // 2. å–å¾—é¡Œç›®åˆ—è¡¨
        async function fetchQuestions() {
            const listContainer = document.getElementById('questionList');
            try {
                const res = await fetch('/api/teacher/questions');
                const questions = await res.json();

                if (questions.length === 0) {
                    listContainer.innerHTML = '<div class="text-center py-12 text-slate-400 bg-white rounded-xl">ç›®å‰é‚„æ²’æœ‰ç™¼å¸ƒéé¡Œç›®ã€‚</div>';
                    return;
                }

                listContainer.innerHTML = questions.map(q => renderQuestionCard(q)).join('');
            } catch (err) {
                listContainer.innerHTML = `<div class="text-red-500 bg-red-50 p-4 rounded-lg text-center font-bold">è®€å–å¤±æ•—ï¼š${err.message}</div>`;
            }
        }

        // 3. æ¸²æŸ“é¡Œç›®å¡ç‰‡ (ä¾ç…§è¦æ ¼ è‚†/å…« åŒ…å«å‰©é¤˜æ™‚é–“èˆ‡ç‹€æ…‹)
        function renderQuestionCard(q) {
            const isClosed = new Date() > new Date(q.deadline);
            const statusLabel = isClosed ? 
                '<span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-bold">åœæ­¢æ”¶ä»¶</span>' : 
                '<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold animate-pulse">æ”¶ä»¶ä¸­</span>';
            
            return `
                <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 transition hover:shadow-md">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            ${statusLabel}
                            <span class="text-slate-400 text-xs">ID: ${q.id}</span>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 mb-1">${q.title}</h3>
                        <p class="text-slate-500 text-sm">æˆªæ­¢æ™‚é–“ï¼š${new Date(q.deadline).toLocaleString()}</p>
                    </div>
                    
                    <div class="flex flex-wrap gap-2 w-full md:w-auto">
                        <button onclick="viewRanking(${q.id})" class="flex-1 md:flex-none bg-amber-500 text-white px-4 py-2 rounded-lg font-bold text-sm">æ’å</button>
                        <button onclick="viewAnswers(${q.id})" class="flex-1 md:flex-none bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm">æŸ¥çœ‹å…§å®¹</button>
                        <button onclick="openManage(${q.id})" class="flex-1 md:flex-none bg-slate-200 text-slate-700 px-4 py-2 rounded-lg font-bold text-sm">ç®¡ç†</button>
                    </div>
                </div>
            `;
        }

        // --- äº’å‹•æ§åˆ¶ ---

        function switchTab(tab) {
            ['questions', 'students', 'settings'].forEach(t => {
                document.getElementById(`section-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('tab-active', 'text-slate-500');
            });
            document.getElementById(`section-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
        }

        function openCreateModal() { document.getElementById('createModal').classList.remove('hidden'); }
        function closeCreateModal() { document.getElementById('createModal').classList.add('hidden'); }

        async function submitNewQuestion() {
            const btn = document.getElementById('confirmCreateBtn');
            const title = document.getElementById('newTitle').value.trim();
            const hours = parseInt(document.getElementById('deadlineHours').value) || 0;
            const mins = parseInt(document.getElementById('deadlineMins').value) || 0;

            if (!title) return alert('è«‹è¼¸å…¥é¡Œç›®åç¨±');
            if (hours === 0 && mins === 0) return alert('è«‹è¨­å®šæœ‰æ•ˆæˆªæ­¢æ™‚é–“');

            btn.disabled = true;
            btn.innerText = 'ç™¼å¸ƒä¸­...';

            try {
                const res = await fetch('/api/teacher/create-question', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, durationMins: (hours * 60) + mins })
                });
                if (!res.ok) throw new Error('ç™¼å¸ƒå¤±æ•—');
                alert('ç™¼å¸ƒæˆåŠŸï¼');
                closeCreateModal();
                fetchQuestions();
            } catch (err) {
                alert(err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = 'ç¢ºèªç™¼å¸ƒ';
            }
        }

        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = 'teacher_login.html';
        }
    </script>
</body>
</html>
