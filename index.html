<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¸ç”Ÿç™»å…¥ - å•ç­”ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* é˜²æ­¢ iOS é›™æ“Šç¸®æ”¾ï¼Œå„ªåŒ–è§¸æ§é«”é©— */
        button, input { touch-action: manipulation; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: bold; }
        .tab-inactive { color: #6b7280; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col items-center justify-center p-4">

    <!-- ä¸»å¡ç‰‡ -->
    <div class="bg-white w-full max-w-md rounded-xl shadow-lg overflow-hidden">
        
        <!-- é ‚éƒ¨åˆ‡æ›é ç±¤ -->
        <div class="flex border-b">
            <button onclick="switchTab('login')" id="tab-login" class="flex-1 py-4 text-center tab-active transition-all">
                å­¸ç”Ÿç™»å…¥
            </button>
            <button onclick="switchTab('register')" id="tab-register" class="flex-1 py-4 text-center tab-inactive transition-all">
                è¨»å†Šå¸³è™Ÿ
            </button>
        </div>

        <!-- å…§å®¹å€åŸŸ -->
        <div class="p-6">
            
            <!-- éŒ¯èª¤è¨Šæ¯æç¤ºæ¡† -->
            <div id="error-box" class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded mb-4 text-sm font-bold"></div>

            <!-- 1. ç™»å…¥è¡¨å–® -->
            <form id="form-login" onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-bold mb-1">å¸³è™Ÿ</label>
                    <input type="text" name="username" required placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-lg">
                </div>
                <div>
                    <label class="block text-gray-700 font-bold mb-1">å¯†ç¢¼</label>
                    <input type="password" name="password" required placeholder="è«‹è¼¸å…¥å¯†ç¢¼" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-lg">
                </div>
                <button type="submit" id="btn-login" class="w-full bg-blue-600 text-white py-3 rounded-lg text-lg font-bold shadow hover:bg-blue-700 transition">
                    ç™»å…¥ç³»çµ±
                </button>
            </form>

            <!-- 2. è¨»å†Šè¡¨å–® (é è¨­éš±è—) -->
            <form id="form-register" onsubmit="handleRegister(event)" class="space-y-4 hidden">
                <div class="bg-blue-50 p-3 rounded text-sm text-blue-800 mb-2">
                    ğŸ“¢ è«‹è¼¸å…¥è€å¸«æä¾›çš„ã€Œç­ç´šé‚€è«‹ç¢¼ã€æ‰èƒ½è¨»å†Šã€‚
                </div>
                <div>
                    <label class="block text-gray-700 font-bold mb-1">ç­ç´šé‚€è«‹ç¢¼</label>
                    <input type="text" name="invite_code" required placeholder="ä¾‹å¦‚ï¼šABCD" 
                           class="w-full p-3 border-2 border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-lg uppercase">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-gray-700 font-bold mb-1">å¸³è™Ÿ</label>
                        <input type="text" name="username" required placeholder="è‹±æ•¸å¸³è™Ÿ" 
                               class="w-full p-3 border border-gray-300 rounded-lg outline-none">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-bold mb-1">ç¶½è™Ÿ</label>
                        <input type="text" name="nickname" required placeholder="é¡¯ç¤ºåç¨±" 
                               class="w-full p-3 border border-gray-300 rounded-lg outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-gray-700 font-bold mb-1">å¯†ç¢¼</label>
                    <input type="password" name="password" required placeholder="è¨­å®šå¯†ç¢¼" 
                           class="w-full p-3 border border-gray-300 rounded-lg outline-none">
                </div>
                
                <!-- å®‰å…¨å•é¡Œ (æ‰¾å›å¯†ç¢¼ç”¨) -->
                <div class="border-t pt-3 mt-2">
                    <p class="text-xs text-gray-500 mb-2">å®‰å…¨å•é¡Œ (å¿˜è¨˜å¯†ç¢¼æ™‚ä½¿ç”¨)</p>
                    <input type="text" name="security_question" required placeholder="å•é¡Œ (ä¾‹: çˆ¸çˆ¸åå­—?)" 
                           class="w-full p-2 border border-gray-300 rounded mb-2 text-sm">
                    <input type="text" name="security_answer" required placeholder="ç­”æ¡ˆ" 
                           class="w-full p-2 border border-gray-300 rounded text-sm">
                </div>

                <button type="submit" id="btn-register" class="w-full bg-green-600 text-white py-3 rounded-lg text-lg font-bold shadow hover:bg-green-700 transition">
                    ç¢ºèªè¨»å†Š
                </button>
            </form>
        </div>
    </div>

    <!-- JavaScript é‚è¼¯ -->
    <script>
        // åˆ‡æ› ç™»å…¥/è¨»å†Š é ç±¤
        function switchTab(tab) {
            document.getElementById('error-box').classList.add('hidden'); // æ¸…é™¤éŒ¯èª¤è¨Šæ¯
            
            if (tab === 'login') {
                document.getElementById('form-login').classList.remove('hidden');
                document.getElementById('form-register').classList.add('hidden');
                document.getElementById('tab-login').className = "flex-1 py-4 text-center tab-active transition-all cursor-default";
                document.getElementById('tab-register').className = "flex-1 py-4 text-center tab-inactive transition-all cursor-pointer bg-gray-50";
            } else {
                document.getElementById('form-login').classList.add('hidden');
                document.getElementById('form-register').classList.remove('hidden');
                document.getElementById('tab-login').className = "flex-1 py-4 text-center tab-inactive transition-all cursor-pointer bg-gray-50";
                document.getElementById('tab-register').className = "flex-1 py-4 text-center tab-active transition-all cursor-default";
            }
        }

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showError(msg) {
            const box = document.getElementById('error-box');
            box.innerText = msg;
            box.classList.remove('hidden');
        }

        // è™•ç†ç™»å…¥
        async function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-login');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "é©—è­‰ä¸­...";
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.role = "student"; // å¼·åˆ¶æŒ‡å®šèº«åˆ†

            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();

                if (result.success) {
                    // ç™»å…¥æˆåŠŸï¼Œè·³è½‰è‡³å­¸ç”Ÿä¸»é 
                    window.location.href = '/student.html';
                } else {
                    showError(result.error || "ç™»å…¥å¤±æ•—");
                }
            } catch (err) {
                showError("é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        // è™•ç†è¨»å†Š
        async function handleRegister(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-register');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "è¨»å†Šä¸­...";

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            try {
                // æ³¨æ„ï¼šé€™è£¡å‘¼å«çš„æ˜¯ student-register API
                const res = await fetch('/api/auth/student-register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();

                if (result.success) {
                    alert("è¨»å†ŠæˆåŠŸï¼è«‹ç›´æ¥ç™»å…¥ã€‚");
                    switchTab('login'); // è‡ªå‹•åˆ‡æ›å›ç™»å…¥é 
                } else {
                    showError(result.error || "è¨»å†Šå¤±æ•—");
                }
            } catch (err) {
                showError("é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }
    </script>
</body>
</html>
